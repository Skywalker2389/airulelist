name: Auto update rule metadata

on:
  push:
    paths:
      - "**/*.list"
      - "**/*.conf"
      - "README.md"

jobs:
  update-metadata:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      # =======================
      # 1. 更新被修改的 .list
      # =======================
      - name: Update changed .list files
        run: |
          set -e

          TIME=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M:%S")
          CHANGED_LISTS=$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" | grep '\.list$' || true)

          if [ -z "$CHANGED_LISTS" ]; then
            echo "No .list files changed"
          fi

          for file in $CHANGED_LISTS; do
            [ -f "$file" ] || continue
            echo "Updating list: $file"

            COUNT=$(grep -v '^\s*$' "$file" | grep -v '^\s*#' | wc -l | tr -d ' ')

            sed -i '/^# UPDATED:/d' "$file"
            sed -i '/^# COUNT:/d' "$file"

            sed -i "1i# COUNT: ${COUNT}" "$file"
            sed -i "1i# UPDATED: ${TIME}" "$file"
          done

      # =======================
      # 2. 更新被修改的 .conf
      # =======================
      - name: Update changed .conf files
        run: |
          set -e

          TIME=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M:%S")
          CHANGED_CONFS=$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" | grep '\.conf$' || true)

          if [ -z "$CHANGED_CONFS" ]; then
            echo "No .conf files changed"
          fi

          for file in $CHANGED_CONFS; do
            [ -f "$file" ] || continue
            echo "Updating conf: $file"

            sed -i '/^# UPDATED:/d' "$file"
            sed -i "1i# UPDATED: ${TIME}" "$file"
          done

      # =======================
      # 3. 更新 README（list + conf）
      # =======================
      - name: Update README statistics
        run: |
          set -e

          START="<!-- RULE_STATS_START -->"
          END="<!-- RULE_STATS_END -->"

          TMP=$(mktemp)

          echo "| Type | File | Count | Updated |" >> "$TMP"
          echo "|------|------|-------|---------|" >> "$TMP"

          find . \( -name "*.list" -o -name "*.conf" \) | sort | while read file; do
            TYPE="${file##*.}"
            FILE="${file#./}"

            UPDATED=$(grep "^# UPDATED:" "$file" | head -n1 | sed 's/# UPDATED: //')

            if [ "$TYPE" = "list" ]; then
              COUNT=$(grep -v '^\s*$' "$file" | grep -v '^\s*#' | wc -l | tr -d ' ')
            else
              COUNT="-"
            fi

            echo "| $TYPE | $FILE | $COUNT | $UPDATED |" >> "$TMP"
          done

          awk -v start="$START" -v end="$END" -v repl="$(cat "$TMP")" '
            $0 ~ start {print; print repl; skip=1; next}
            $0 ~ end {skip=0; print; next}
            !skip
          ' README.md > README.md.new

          mv README.md.new README.md

      # =======================
      # 4. 提交变更
      # =======================
      - name: Commit and push if needed
        run: |
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add .
            git commit -m "chore: auto update rule metadata"
            git push
          fi
